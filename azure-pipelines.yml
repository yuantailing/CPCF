# Xcode
# Build, test, and archive an Xcode workspace on macOS.
# Add steps that install certificates, test, sign, and distribute an app, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/xcode

jobs:
- job: MacOS

  strategy:
    matrix:
      Debug:
        Configuration: Debug
      Release:
        Configuration: Release
  pool:
    vmImage: 'macos-latest'

  steps:
  - bash: |
      set -ex
      curl -L https://github.com/jiapw/CPCF/releases/download/CPCF-Libs/cpcf_mac_ipp.7z -o./cpcf_mac_ipp.7z
      brew install p7zip
      7z x cpcf_mac_ipp.7z -olibs/mac/
      rm cpcf_mac_ipp.7z
    displayName: Retrieve libs
  - bash: find .
    displayName: find .

  - task: Xcode@5
    inputs:
      actions: 'build'
      sdk: 'macosx10.14'
      xcWorkspacePath: 'testcases/proj.mac/*.xcodeproj/project.xcworkspace'
      packageApp: false

  - bash: find .
    displayName: find .

  - bash: find ${HOME}/Library/Developer
    displayName: find Developer

  - bash: |
      set -ex
      mv ../testcases.log ../testcases.std
      ${HOME}/Library/Developer/Xcode/DerivedData/tester-*/Build/Products/${CONFIGURATION}/tester --verify
      diff ../testcases.std ../testcases.log
    workingDirectory: testcases/proj.mac
