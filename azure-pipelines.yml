# Xcode
# Build, test, and archive an Xcode workspace on macOS.
# Add steps that install certificates, test, sign, and distribute an app, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/xcode

jobs:
- job: MacOS

  strategy:
    matrix:
      10.14 Debug:
        vmImage: 'macos-10.14'
        Configuration: Debug
      10.14 Release:
        vmImage: 'macos-10.14'
        Configuration: Release
  pool:
    vmImage: $(vmImage)

  steps:
  - bash: |
      set -ex
      curl https://github.com/jiapw/CPCF/releases/download/CPCF-Libs/cpcf_mac_ipp.7z -Locpcf_mac_ipp.7z
      brew install p7zip
      7z x cpcf_mac_ipp.7z -olibs/mac/
      rm cpcf_mac_ipp.7z
    displayName: Retrieve libs

  - task: Xcode@5
    inputs:
      actions: 'build'
      sdk: 'macosx10.14'
      xcWorkspacePath: 'testcases/proj.mac/*.xcodeproj/project.xcworkspace'
      packageApp: false

  - bash: |
      set -ex
      mv ../testcases.log ../testcases.std
      ${HOME}/Library/Developer/Xcode/DerivedData/tester-*/Build/Products/${CONFIGURATION}/tester --verify
      sed '/LoadEnvironmentVariablesAsOptions on Mac\/iOS is not implemented/d' -i '' ../testcases.log
    displayName: Run
    workingDirectory: 'testcases/proj.mac'

  - bash: diff ../testcases.std ../testcases.log
    displayName: diff
    workingDirectory: 'testcases/proj.mac'
